From 0bbf7b567d6a3c4ddbdafcba8232f3a2f776a9dc Mon Sep 17 00:00:00 2001
From: Fijxu <fijxu@nadeko.net>
Date: Mon, 24 Mar 2025 21:15:38 -0300
Subject: [PATCH] feat: add option to force proxying of videos

---
 src/invidious/config.cr                   | 2 ++
 src/invidious/videos/video_preferences.cr | 4 +++-
 src/invidious/views/user/preferences.ecr  | 5 ++++-
 3 files changed, 9 insertions(+), 2 deletions(-)

diff --git a/src/invidious/config.cr b/src/invidious/config.cr
index d1ce7bff..9df2bbda 100644
--- a/src/invidious/config.cr
+++ b/src/invidious/config.cr
@@ -192,6 +192,8 @@ class Config
 
   property video_cache : VideoCacheConfig
 
+  property force_local : Bool = true
+
   class VideoCacheConfig
     include YAML::Serializable
 
diff --git a/src/invidious/videos/video_preferences.cr b/src/invidious/videos/video_preferences.cr
index 48177bd8..843ef30f 100644
--- a/src/invidious/videos/video_preferences.cr
+++ b/src/invidious/videos/video_preferences.cr
@@ -109,7 +109,9 @@ def process_video_params(query, preferences)
     quality = "high"
   end
 
-  if CONFIG.disabled?("local") && local
+  if CONFIG.force_local
+    local = true
+  elsif CONFIG.disabled?("local") && local
     local = false
   end
 
diff --git a/src/invidious/views/user/preferences.ecr b/src/invidious/views/user/preferences.ecr
index 23cb89f6..3387244d 100644
--- a/src/invidious/views/user/preferences.ecr
+++ b/src/invidious/views/user/preferences.ecr
@@ -34,7 +34,10 @@
 
             <div class="pure-control-group">
                 <label for="local"><%= translate(locale, "preferences_local_label") %></label>
-                <input name="local" id="local" type="checkbox" <% if preferences.local && !CONFIG.disabled?("local") %>checked<% end %> <% if CONFIG.disabled?("local") %>disabled<% end %>>
+                <input name="local" id="local" type="checkbox" <% if CONFIG.force_local %>disabled="" <% end %><% if preferences.local && !CONFIG.disabled?("local") %>checked<% end %> <% if CONFIG.disabled?("local") %>disabled<% end %>>
+                <% if CONFIG.force_local %>
+                    <label for="local">(All videos are proxied by default)</label>
+                <% end %>
             </div>
 
             <div class="pure-control-group">
-- 
2.51.0

