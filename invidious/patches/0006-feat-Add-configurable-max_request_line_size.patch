From 839ada20e845027ad691a9d21d6eceace63f5d6e Mon Sep 17 00:00:00 2001
From: putara <38089082+putara@users.noreply.github.com>
Date: Thu, 13 Nov 2025 20:00:59 +1300
Subject: [PATCH] feat: Add configurable max_request_line_size (based on #5394)

---
 config/config.example.yml | 13 +++++++++++++
 src/invidious.cr          |  5 +++++
 src/invidious/config.cr   |  2 ++
 3 files changed, 20 insertions(+)

diff --git a/config/config.example.yml b/config/config.example.yml
index 2b99345b..77c5aac9 100644
--- a/config/config.example.yml
+++ b/config/config.example.yml
@@ -192,6 +192,19 @@ https_only: false
 #  path: /tmp/invidious.sock
 #  permissions: 777
 
+##
+## Maximum size of the HTTP request line (in bytes).
+## Increase this value if you encounter 414 errors when using URLs with long
+## query parameters (e.g., very long continuation tokens).
+##
+## Note: This directly sets the HTTP server's max_request_line_size.
+## Be cautious when increasing this value on public instances.
+##
+## Accepted values: integer (size in bytes)
+## Default: <none> (8192 by Crystal)
+##
+#max_request_line_size: 8192
+
 
 # -----------------------------
 #  Network (outbound)
diff --git a/src/invidious.cr b/src/invidious.cr
index d54d5c79..a38cbbd4 100644
--- a/src/invidious.cr
+++ b/src/invidious.cr
@@ -259,6 +259,11 @@ Kemal.config.app_name = "Invidious"
 {% end %}
 
 Kemal.run do |config|
+  # Set max request line size if configured
+  if max_size = CONFIG.max_request_line_size
+    config.server.not_nil!.max_request_line_size = max_size
+  end
+  
   if socket_binding = CONFIG.socket_binding
     File.delete?(socket_binding.path)
     # Create a socket and set its desired permissions
diff --git a/src/invidious/config.cr b/src/invidious/config.cr
index 9df2bbda..bc5abd34 100644
--- a/src/invidious/config.cr
+++ b/src/invidious/config.cr
@@ -164,6 +164,8 @@ class Config
   property host_binding : String = "0.0.0.0"
   # Path and permissions to make Invidious listen on a UNIX socket instead of a TCP port
   property socket_binding : SocketBindingConfig? = nil
+  # Maximum size of request line (in bytes), increase if you get 414 errors with long URLs
+  property max_request_line_size : Int32? = nil
   # Pool size for HTTP requests to youtube.com and ytimg.com (each domain has a separate pool of `pool_size`)
   property pool_size : Int32 = 100
   # HTTP Proxy configuration
-- 
2.51.0

