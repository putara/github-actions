From c54c6a9dfa663e4b460930f6978bca1d5d038114 Mon Sep 17 00:00:00 2001
From: putara <38089082+putara@users.noreply.github.com>
Date: Mon, 6 Oct 2025 00:44:36 +1300
Subject: [PATCH] Allow http instead of https for local use

---
 src/formatters.nim | 26 +++++++++++++-------------
 1 file changed, 13 insertions(+), 13 deletions(-)

diff --git a/src/formatters.nim b/src/formatters.nim
index 7428814..52538f9 100644
--- a/src/formatters.nim
+++ b/src/formatters.nim
@@ -9,15 +9,15 @@ const
   twitter = parseUri("https://twitter.com")
 
 let
-  twRegex = re"(?<=(?<!\S)https:\/\/|(?<=\s))(www\.|mobile\.)?twitter\.com"
+  twRegex = re"((?<!\S)https?:\/\/|(?<=\s))(www\.|mobile\.)?twitter\.com"
   twLinkRegex = re"""<a href="https:\/\/twitter.com([^"]+)">twitter\.com(\S+)</a>"""
-  xRegex = re"(?<=(?<!\S)https:\/\/|(?<=\s))(www\.|mobile\.)?x\.com"
+  xRegex = re"((?<!\S)https?:\/\/|(?<=\s))(www\.|mobile\.)?x\.com"
   xLinkRegex = re"""<a href="https:\/\/x.com([^"]+)">x\.com(\S+)</a>"""
 
-  ytRegex = re(r"([A-z.]+\.)?youtu(be\.com|\.be)", {reStudy, reIgnoreCase})
+  ytRegex = re(r"((?<!\S)https?:\/\/|(?<=\s))([A-z.]+\.)?youtu(be\.com|\.be)", {reStudy, reIgnoreCase})
 
-  rdRegex = re"(?<![.b])((www|np|new|amp|old)\.)?reddit.com"
-  rdShortRegex = re"(?<![.b])redd\.it\/"
+  rdRegex = re"((?<!\S)https?:\/\/|(?<=\s))(?<![.b])((www|np|new|amp|old)\.)?reddit.com"
+  rdShortRegex = re"((?<!\S)https?:\/\/|(?<=\s))(?<![.b])redd\.it\/"
   # Videos cannot be supported uniformly between Teddit and Libreddit,
   # so v.redd.it links will not be replaced.
   # Images aren't supported due to errors from Teddit when the image
@@ -56,24 +56,24 @@ proc replaceUrls*(body: string; prefs: Prefs; absolute=""): string =
   result = body
 
   if prefs.replaceYouTube.len > 0 and "youtu" in result:
-    result = result.replace(ytRegex, prefs.replaceYouTube)
+    result = result.replace(ytRegex, "//" & prefs.replaceYouTube)
 
   if prefs.replaceTwitter.len > 0:
     if tco in result:
-      result = result.replace(tco, https & prefs.replaceTwitter & "/t.co")
+      result = result.replace(tco, "//" & prefs.replaceTwitter & "/t.co")
     if "x.com" in result:
-      result = result.replace(xRegex, prefs.replaceTwitter)
+      result = result.replace(xRegex, "//" & prefs.replaceTwitter)
       result = result.replacef(xLinkRegex, a(
-        prefs.replaceTwitter & "$2", href = https & prefs.replaceTwitter & "$1"))
+        prefs.replaceTwitter & "$2", href = "//" & prefs.replaceTwitter & "$1"))
     if "twitter.com" in result:
       result = result.replace(cards, prefs.replaceTwitter & "/cards")
-      result = result.replace(twRegex, prefs.replaceTwitter)
+      result = result.replace(twRegex, "//" & prefs.replaceTwitter)
       result = result.replacef(twLinkRegex, a(
-        prefs.replaceTwitter & "$2", href = https & prefs.replaceTwitter & "$1"))
+        prefs.replaceTwitter & "$2", href = "//" & prefs.replaceTwitter & "$1"))
 
   if prefs.replaceReddit.len > 0 and ("reddit.com" in result or "redd.it" in result):
-    result = result.replace(rdShortRegex, prefs.replaceReddit & "/comments/")
-    result = result.replace(rdRegex, prefs.replaceReddit)
+    result = result.replace(rdShortRegex, "//" & prefs.replaceReddit & "/comments/")
+    result = result.replace(rdRegex, "//" & prefs.replaceReddit)
     if prefs.replaceReddit in result and "/gallery/" in result:
       result = result.replace("/gallery/", "/comments/")
 
-- 
2.51.0

