From 0299d58eb13373432120a388da876d79834482d0 Mon Sep 17 00:00:00 2001
From: putara <38089082+putara@users.noreply.github.com>
Date: Mon, 6 Oct 2025 00:44:36 +1300
Subject: [PATCH 1/2] Allow http instead of https for local use

---
 src/formatters.nim | 26 +++++++++++++-------------
 1 file changed, 13 insertions(+), 13 deletions(-)

diff --git a/src/formatters.nim b/src/formatters.nim
index fc0e197..e1e0d99 100644
--- a/src/formatters.nim
+++ b/src/formatters.nim
@@ -9,15 +9,15 @@ const
   twitter = parseUri("https://x.com")
 
 let
-  twRegex = re"(?<=(?<!\S)https:\/\/|(?<=\s))(www\.|mobile\.)?twitter\.com"
+  twRegex = re"(https?:\/\/|(?<=\s))(www\.|mobile\.)?twitter\.com"
   twLinkRegex = re"""<a href="https:\/\/twitter.com([^"]+)">twitter\.com(\S+)</a>"""
-  xRegex = re"(?<=(?<!\S)https:\/\/|(?<=\s))(www\.|mobile\.)?x\.com"
+  xRegex = re"(https?:\/\/|(?<=\s))(www\.|mobile\.)?x\.com"
   xLinkRegex = re"""<a href="https:\/\/x.com([^"]+)">x\.com(\S+)</a>"""
 
-  ytRegex = re(r"([A-z.]+\.)?youtu(be\.com|\.be)", {reStudy, reIgnoreCase})
+  ytRegex = re(r"(https?:\/\/|(?<=\s))([A-z.]+\.)?youtu(be\.com|\.be)", {reStudy, reIgnoreCase})
 
-  rdRegex = re"(?<![.b])((www|np|new|amp|old)\.)?reddit.com"
-  rdShortRegex = re"(?<![.b])redd\.it\/"
+  rdRegex = re"(https?:\/\/|(?<=\s))(?<![.b])((www|np|new|amp|old)\.)?reddit.com"
+  rdShortRegex = re"(https?:\/\/|(?<=\s))(?<![.b])redd\.it\/"
   # Videos cannot be supported uniformly between Teddit and Libreddit,
   # so v.redd.it links will not be replaced.
   # Images aren't supported due to errors from Teddit when the image
@@ -60,26 +60,26 @@ proc replaceUrls*(body: string; prefs: Prefs; absolute=""): string =
 
   if prefs.replaceYouTube.len > 0 and "youtu" in result:
     let youtubeHost = strip(prefs.replaceYouTube, chars={'/'})
-    result = result.replace(ytRegex, youtubeHost)
+    result = result.replace(ytRegex, "//" & youtubeHost)
 
   if prefs.replaceTwitter.len > 0:
     let twitterHost = strip(prefs.replaceTwitter, chars={'/'})
     if tco in result:
-      result = result.replace(tco, https & twitterHost & "/t.co")
+      result = result.replace(tco, "//" & twitterHost & "/t.co")
     if "x.com" in result:
-      result = result.replace(xRegex, twitterHost)
+      result = result.replace(xRegex, "//" & twitterHost)
       result = result.replacef(xLinkRegex, a(
-        twitterHost & "$2", href = https & twitterHost & "$1"))
+        twitterHost & "$2", href = "//" & twitterHost & "$1"))
     if "twitter.com" in result:
       result = result.replace(cards, twitterHost & "/cards")
-      result = result.replace(twRegex, twitterHost)
+      result = result.replace(twRegex, "//" & twitterHost)
       result = result.replacef(twLinkRegex, a(
-        twitterHost & "$2", href = https & twitterHost & "$1"))
+        twitterHost & "$2", href = "//" & twitterHost & "$1"))
 
   if prefs.replaceReddit.len > 0 and ("reddit.com" in result or "redd.it" in result):
     let redditHost = strip(prefs.replaceReddit, chars={'/'})
-    result = result.replace(rdShortRegex, redditHost & "/comments/")
-    result = result.replace(rdRegex, redditHost)
+    result = result.replace(rdShortRegex, "//" & redditHost & "/comments/")
+    result = result.replace(rdRegex, "//" & redditHost)
     if redditHost in result and "/gallery/" in result:
       result = result.replace("/gallery/", "/comments/")
 
-- 
2.51.0

